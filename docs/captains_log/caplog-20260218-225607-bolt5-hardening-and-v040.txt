================================================================================
CAPTAIN'S LOG: bolt5-hardening-and-v040
Date: 2026-02-18 22:56:07
Previous Log: None - First Entry
================================================================================

## Summary
Massive production hardening session. Implemented all 12 Bolt 5 items (security,
logging, error handling, input validation), deployed API key auth to production,
ran full compliance audit, fixed all findings, and cut the v0.4.0 release. Anny
is now properly secured and deployed at anny.membies.com with API key auth live.

## Current State
- v0.4.0 released, tagged, deployed to anny.membies.com
- 145 unit+int tests passing, 19 e2e, 83% coverage, pylint 10/10
- API key auth live in production (X-API-Key header required for all /api/* endpoints)
- Holding pattern — no active Bolt, backlog groomed, ready for next sprint
- OPS readiness: 31/47 (66%) — up from 28/47 at session start
- Motherhen compliance: 6/7 checks passing (only OPS score below 90% threshold)

## Work Completed
- API key authentication for all 13 REST endpoints (Bolt 4 carryover)
- Timing attack fix: hmac.compare_digest() for constant-time key comparison
- File locking: fcntl.flock() with atomic _modify() pattern in MemoryStore
- Enhanced health check: validates config, credentials file, memory path
- Startup config validation: validate_config() with logging warnings
- Structured logging: logging.getLogger("anny") across all modules
- Exception hardening: bare except → GoogleAPICallError, HttpError, ValueError/KeyError
- Credential scrubbing: generic error messages instead of leaking key file details
- MCP input bounds: MAX_LIMIT=100, MAX_ROW_LIMIT=1000 with clamping
- CSV field validation: reject empty metrics/dimensions in service layer
- Custom date range validation: ISO format check, start <= end enforcement
- Rate limiting middleware: 60 req/min per IP on /api/* endpoints
- Removed pytest from pre-commit (kept black + pylint, tests via make test + CI)
- ANNY_API_KEY added to docker-compose.yml environment passthrough
- API key generated and set on production server
- Fixed 15 broken route tests (dependency_overrides.clear() wiped auth override)
- Motherhen compliance audit: re-scored OPS checklist, fixed all stale doc counts
- Updated traceability matrix (127 → 145 tests, added cross-cutting concerns)
- Fixed stale counts in CLAUDE.md, README.md, SECURITY.md, REQUIREMENTS.md
- Released v0.4.0, tagged, pushed, deployed

## Decisions Made
- hmac.compare_digest() over simple != for API key comparison — prevents timing attacks
  even though risk is low for a single-key system
- fcntl.flock() for file locking instead of external library — stdlib, no new deps,
  good enough for single-VPS deployment
- In-memory rate limiting (defaultdict) over Redis — no new infra needed, sufficient
  for single-process uvicorn deployment, resets on restart (acceptable)
- Removed pytest from pre-commit hooks — tests were slowing commits, better to run
  via make test and CI pipeline. Format + lint is enough for commit-time gates.
- Structured logging as text format (not JSON) — simpler for current VPS/docker logs
  setup, can switch to JSON when log aggregation is added

## Issues Encountered
- Route tests broke when ANNY_API_KEY was set in local .env — tests used
  app.dependency_overrides.clear() which wiped the auth override along with
  the client mock override. This was a latent bug that was masked because
  .env had no API key until this session.
- Deploy script health check times out during Docker rebuild — SSH connection
  gets refused briefly while the container restarts. Not a real failure, just
  a timing issue. Container comes up fine, verified via direct curl.
- Memory directory (/home/anny/.anny/) gets wiped on container rebuild — no
  Docker volume mount for it. Created manually post-deploy. Should add a
  volume in docker-compose.yml for persistence.
- Pre-commit black reformatted files after initial commit attempt — needed to
  re-stage and create new commit (happened twice this session).

## Commits Made
- 9f46b75: Add API key authentication to all REST endpoints (H-001)
- 8942099: Harden security, logging, error handling, and input validation (Bolt 5)
- 2f5228a: Add input validation, rate limiting, and streamline pre-commit
- b32a395: Close Bolt 5, update PM docs and changelog (12/12 items done)
- c004a6b: Pass ANNY_API_KEY to container via docker-compose
- a12507b: Fix route tests to override verify_api_key when ANNY_API_KEY is set
- 9721cc4: Update compliance docs: re-score OPS checklist, fix stale counts
- 5f7ce9c: Release v0.4.0 — Security Hardening + Production Auth
- c74fdd9: Update PM docs: v0.4.0 deployed, fix deploy counts

## Mistakes & Lessons
- dependency_overrides.clear() is dangerous — it nukes ALL overrides, not just
  the one you set. Always use targeted .pop() instead. This bug was invisible
  until the API key was actually configured, meaning the auth tests only tested
  the "auth disabled" path in CI. Need to ensure tests work both with and
  without ANNY_API_KEY set.
- Always run make test AFTER setting new env vars locally — the .env is loaded
  by pydantic-settings at import time, so adding ANNY_API_KEY changes behavior
  of every test that touches the app.
- Docker memory directory needs a volume mount — without it, memory.json is
  lost on every container rebuild. This is a backlog item now.

## Next Steps
- Add Docker volume for ~/.anny/memory.json persistence (prevents data loss on rebuild)
- CI pipeline update (#16) — add new deps to GitHub Actions
- Monitoring/alerting (#18) — uptime monitoring for anny.membies.com
- Consider OPS checklist push toward 90%: CORS, incident runbook, backup strategy,
  smoke test post-deploy, CD pipeline
- When ready for feature work: query cache (#25), GA4 realtime (#19)
- Run a fresh five-persona security review before next major deploy (protocol says
  review before every production deployment with code changes)

================================================================================
END OF LOG
================================================================================
